{% extends 'html/base.html' %}
{% load static %}
{% load stok_tags %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb">
        <a href="{% url 'home' %}" class="breadcrumb-item">Depo</a>
        <i class="fas fa-chevron-right"></i>
        <span class="breadcrumb-item active">Ürünler</span>
    </div>

    <div class="table-filter-bar">
        <select id="filter-column">
            <option value="all">Tümü</option>
            <option value="1">Ürün Adı</option>
            <option value="2">Ürün Kodu</option>
            <option value="3">Muhasebe Kodu</option>
            <option value="4">Tedarikçi Kodu</option>
            <option value="5">Açıklama</option>
            <option value="6">Adet</option>
            <option value="7">Asgari Adet</option>
            <option value="8">Birim</option>
            <option value="9">Raf No</option>
            <option value="10">Marka</option>
            <option value="11">Oluşturulma</option>
            <option value="12">Güncellenme</option>
        </select>
        
        <input type="text" id="table-filter-input" placeholder="Arama yapın veya filtreleyin... (Büyük/küçük harf duyarsız)">
        
        <button id="clear-filter" class="clear-button">
            <i class="fa fa-times"></i>
        </button>

        <button class="btn btn-primary urun-cikis-btn" data-bs-toggle="modal" data-bs-target="#urunCikisPopup">
            <i class="fas fa-box-open fa-lg"></i>
            <span><br>Ürün Çıkış</span>
        </button>
    </div>

    <div class="quick-filter-buttons" style="margin-top: 10px; text-align: center;">
        <button class="btn btn-secondary" style="margin-right: 5px;" onclick="showAllProducts()">Tüm Ürünler</button>
        <button class="btn btn-warning" style="margin-right: 5px;" onclick="showYellowWarnings()">Öncü Uyarı</button>
        <button class="btn btn-danger" onclick="showRedWarnings()">Kritik Uyarı</button>
    </div>

    <div id="main">
        <table id="data-table" class="table table-striped table-bordered">
            <thead>
                <tr class="table100-head">
                    <th class="column1">No</th>
                    <th class="column2">Ürün Adı</th>
                    <th class="column3">Ürün Kodu</th>
                    <th class="column4">Muhasebe Kodu</th>
                    <th class="column5">Tedarikçi</th>
                    <th class="column6">Açıklama</th>
                    <th class="column7">Adet</th>
                    <th class="column8">Asgari</th>
                    <th class="column9">Birim</th>
                    <th class="column10">Raf</th>
                    <th class="column11">Marka</th>
                    {% if user.is_staff %}
                    <th class="column12">Oluşturulma</th>
                    {% endif %}
                    <th class="column13">Güncellenme</th>
                    <th class="column14" style="width: 200px;">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr class="{% if product.adet <= product.asgari_adet %}stok-kritik{% elif product.adet <= product.asgari_adet|multiply:uyari_yuzdesi %}stok-uyari{% endif %}">
                    <td class="column1">{{ forloop.counter }}</td>
                    <td class="column2">{{ product.isim }}</td>
                    <td class="column3">{{ product.urun_kodu }}</td>
                    <td class="column4">{{ product.muhasebe_kodu }}</td>
                    <td class="column5">{{ product.tedarikci_kodu|default:"-" }}</td>
                    <td class="column6">{{ product.aciklama }}</td>
                    <td class="column7">{{ product.adet }}</td>
                    <td class="column8">{{ product.asgari_adet }}</td>
                    <td class="column9">{{ product.birim }}</td>
                    <td class="column10">{{ product.raf_no }}</td>
                    <td class="column11">{{ product.marka }}</td>
                    {% if user.is_staff %}
                    <td class="column12">
                        {{ product.olusturma_tarihi|date:"d.m.Y" }}<br>
                        {{ product.olusturma_saat|time:"H:i" }}
                    </td>
                    {% endif %}
                    <td class="column13">
                        {{ product.guncelleme_tarihi|date:"d.m.Y" }}<br>
                        {{ product.guncelleme_saat|time:"H:i" }}
                    </td>
                    <td class="column14">
                        {% if user.is_authenticated %}
                            {% if product.adet <= product.asgari_adet %}
                            <div class="warning-icon-container" title="Kritik Stok Seviyesi!">
                                <i class="fas fa-exclamation-circle warning-icon"></i>
                            </div>
                            {% endif %}
                            <a href="{% url 'admin:stok_product_change' product.id %}" class="btn btn-warning btn-sm" title="Düzenle">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-info btn-sm" onclick="generateQRCode('{{ product.raf_no }}')" title="QR Kod Oluştur">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
$(document).ready(function() {
    // DataTables initialization
    var table = $('#data-table').DataTable({
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Tümü"]],
        "language": {
            "lengthMenu": "Sayfa başına _MENU_ kayıt göster",
            "zeroRecords": "Kayıt bulunamadı",
            "info": "Toplam _TOTAL_ kayıttan _START_ - _END_ arası gösteriliyor",
            "infoEmpty": "Kayıt yok",
            "infoFiltered": "(_MAX_ kayıt içerisinden bulunan)",
            "search": "",
            "paginate": {
                "first": "İlk",
                "last": "Son",
                "next": "Sonraki",
                "previous": "Önceki"
            }
        },
        "order": [[0, 'asc']],
        "columnDefs": [
            { "orderable": false, "targets": [13] } // İşlemler sütunu sıralanamaz
        ],
        "dom": '<"top"l>rt<"bottom"ip><"clear">', // Arama kutusunu kaldır
        "initComplete": function() {
            // DataTables'ın varsayılan arama kutusunu gizle
            $('.dataTables_filter').hide();
        }
    });

    // Mevcut filtreleme fonksiyonlarını DataTables ile entegre et
    $('#filter-column').on('change', function() {
        var columnIndex = $(this).val();
        if (columnIndex === 'all') {
            table.column().search('').draw();
        } else {
            table.column(parseInt(columnIndex) - 1).search($('#table-filter-input').val()).draw();
        }
    });

    $('#table-filter-input').on('keyup', function() {
        var columnIndex = $('#filter-column').val();
        if (columnIndex === 'all') {
            table.search(this.value).draw();
        } else {
            table.column(parseInt(columnIndex) - 1).search(this.value).draw();
        }
    });

    $('#clear-filter').on('click', function() {
        $('#table-filter-input').val('');
        $('#filter-column').val('all');
        table.search('').columns().search('').draw();
    });
});

function showAllProducts() {
    var table = $('#data-table').DataTable();
    table.search('').draw();
}

function showYellowWarnings() {
    var table = $('#data-table').DataTable();
    table.search('').draw();
    $('.stok-uyari').show();
    $('tr:not(.stok-uyari)').hide();
}

function showRedWarnings() {
    var table = $('#data-table').DataTable();
    table.search('').draw();
    $('.stok-kritik').show();
    $('tr:not(.stok-kritik)').hide();
}

function generateQRCode(rafNo) {
    if (!rafNo) {
        alert('Raf bilgisi mevcut değil.');
        return;
    }
    var qr = new QRious({
        value: rafNo,
        size: 200
    });
    
    var link = document.createElement('a');
    link.href = qr.toDataURL();
    link.download = rafNo + '.png';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    alert('QR kodu oluşturuldu ve kaydedilecek yeri seçin.');
}
</script>
{% endblock %} 